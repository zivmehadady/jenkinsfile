pipeline {
    agent {
        docker {
            image 'myimage'
            privileged true
            label 'zip-job-docker'
        }
    }
    stages {
        stage('Build') {
            steps {
                sh 'python /tmp/zip_job.py'
            }
        }
        stage('Publish') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'artifactory', passwordVariable: 'ARTIFACTORY_PASSWORD', usernameVariable: 'ARTIFACTORY_USERNAME')]) {
                    sh '''
                    set -e
                    zip_files=$(find . -name "*.zip")
                    for zip_file in $zip_files; do
                        curl -u$ARTIFACTORY_USERNAME:$ARTIFACTORY_PASSWORD -X PUT "https://artifactory-tlv/binary-storage/${VERSION}/${zip_file}" -T "${zip_file}"
                    done
                    '''
                }
            }
        }
        stage('Report') {
            steps {
                mail to: 'some@email.com', subject: "${currentBuild.currentResult}: ${env.JOB_NAME} #${env.BUILD_NUMBER}", body: '''
                <p>Job: ${env.JOB_NAME}</p>
                <p>Build number: ${env.BUILD_NUMBER}</p>
                <p>Status: ${currentBuild.currentResult}</p>
                '''
            }
        }
        stage('Cleanup') {
            steps {
                deleteDir()
            }
        }
    }
}
